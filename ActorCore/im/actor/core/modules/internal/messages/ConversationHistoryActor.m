//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/ConversationHistoryActor.java
//

#include "J2ObjC_source.h"
#include "im/actor/core/api/ApiOutPeer.h"
#include "im/actor/core/api/rpc/RequestLoadHistory.h"
#include "im/actor/core/api/rpc/ResponseLoadHistory.h"
#include "im/actor/core/entity/Peer.h"
#include "im/actor/core/modules/ModuleContext.h"
#include "im/actor/core/modules/Updates.h"
#include "im/actor/core/modules/internal/messages/ConversationHistoryActor.h"
#include "im/actor/core/modules/updates/internal/MessagesHistoryLoaded.h"
#include "im/actor/core/modules/utils/ModuleActor.h"
#include "im/actor/core/network/RpcCallback.h"
#include "im/actor/core/network/RpcException.h"
#include "im/actor/runtime/actors/Actor.h"
#include "im/actor/runtime/actors/ActorRef.h"
#include "im/actor/runtime/storage/PreferencesStorage.h"
#include "java/lang/Long.h"

#pragma clang diagnostic push
#pragma GCC diagnostic ignored "-Wdeprecated-declarations"

#define ACConversationHistoryActor_LIMIT 20

@interface ACConversationHistoryActor () {
 @public
  NSString *KEY_LOADED_DATE_;
  NSString *KEY_LOADED_;
  NSString *KEY_LOADED_INIT_;
  ACPeer *peer_;
  jlong historyMaxDate_;
  jboolean historyLoaded_;
  jboolean isLoading_;
}

- (void)onLoadMore;

- (void)onLoadedMoreWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate;

@end

J2OBJC_FIELD_SETTER(ACConversationHistoryActor, KEY_LOADED_DATE_, NSString *)
J2OBJC_FIELD_SETTER(ACConversationHistoryActor, KEY_LOADED_, NSString *)
J2OBJC_FIELD_SETTER(ACConversationHistoryActor, KEY_LOADED_INIT_, NSString *)
J2OBJC_FIELD_SETTER(ACConversationHistoryActor, peer_, ACPeer *)

J2OBJC_STATIC_FIELD_GETTER(ACConversationHistoryActor, LIMIT, jint)

__attribute__((unused)) static void ACConversationHistoryActor_onLoadMore(ACConversationHistoryActor *self);

__attribute__((unused)) static void ACConversationHistoryActor_onLoadedMoreWithInt_withLong_(ACConversationHistoryActor *self, jint loaded, jlong maxLoadedDate);

@interface ACConversationHistoryActor_LoadedMore () {
 @public
  jint loaded_;
  jlong maxLoadedDate_;
}

@end

@interface ACConversationHistoryActor_$1 : NSObject < ACRpcCallback > {
 @public
  ACConversationHistoryActor *this$0_;
}

- (void)onResult:(ARResponseLoadHistory *)response;

- (void)onError:(ACRpcException *)e;

- (instancetype)initWithACConversationHistoryActor:(ACConversationHistoryActor *)outer$;

@end

J2OBJC_EMPTY_STATIC_INIT(ACConversationHistoryActor_$1)

J2OBJC_FIELD_SETTER(ACConversationHistoryActor_$1, this$0_, ACConversationHistoryActor *)

__attribute__((unused)) static void ACConversationHistoryActor_$1_initWithACConversationHistoryActor_(ACConversationHistoryActor_$1 *self, ACConversationHistoryActor *outer$);

__attribute__((unused)) static ACConversationHistoryActor_$1 *new_ACConversationHistoryActor_$1_initWithACConversationHistoryActor_(ACConversationHistoryActor *outer$) NS_RETURNS_RETAINED;

J2OBJC_TYPE_LITERAL_HEADER(ACConversationHistoryActor_$1)

#line 0 "/Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/ConversationHistoryActor.java"


#line 16
@implementation ACConversationHistoryActor


#line 30
- (instancetype)initWithACPeer:(ACPeer *)peer
           withACModuleContext:(id<ACModuleContext>)context {
  ACConversationHistoryActor_initWithACPeer_withACModuleContext_(self, peer, context);
  return self;
}


#line 39
- (void)preStart {
  [super preStart];
  historyMaxDate_ = [((id<ARPreferencesStorage>) nil_chk([self preferences])) getLongWithKey:KEY_LOADED_DATE_ withDefault:JavaLangLong_MAX_VALUE];
  historyLoaded_ = [((id<ARPreferencesStorage>) nil_chk([self preferences])) getBoolWithKey:KEY_LOADED_ withDefault:false];
  if (![((id<ARPreferencesStorage>) nil_chk([self preferences])) getBoolWithKey:KEY_LOADED_INIT_ withDefault:false]) {
    [((ARActorRef *) nil_chk([self self__])) sendOnceWithId:new_ACConversationHistoryActor_LoadMore_init()];
  }
}

- (void)onLoadMore {
  ACConversationHistoryActor_onLoadMore(self);
}


#line 73
- (void)onLoadedMoreWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate {
  ACConversationHistoryActor_onLoadedMoreWithInt_withLong_(self, loaded, maxLoadedDate);
}


#line 89
- (void)onReceiveWithId:(id)message {
  if ([message isKindOfClass:[ACConversationHistoryActor_LoadMore class]]) {
    ACConversationHistoryActor_onLoadMore(self);
  }
  else
#line 92
  if ([message isKindOfClass:[ACConversationHistoryActor_LoadedMore class]]) {
    ACConversationHistoryActor_LoadedMore *loadedMore = (ACConversationHistoryActor_LoadedMore *) check_class_cast(message, [ACConversationHistoryActor_LoadedMore class]);
    ACConversationHistoryActor_onLoadedMoreWithInt_withLong_(self, ((ACConversationHistoryActor_LoadedMore *) nil_chk(loadedMore))->loaded_, loadedMore->maxLoadedDate_);
  }
  else {
    
#line 96
    [self dropWithId:message];
  }
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithACPeer:withACModuleContext:", "ConversationHistoryActor", NULL, 0x1, NULL, NULL },
    { "preStart", NULL, "V", 0x1, NULL, NULL },
    { "onLoadMore", NULL, "V", 0x2, NULL, NULL },
    { "onLoadedMoreWithInt:withLong:", "onLoadedMore", "V", 0x2, NULL, NULL },
    { "onReceiveWithId:", "onReceive", "V", 0x1, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "LIMIT", "LIMIT", 0x1a, "I", NULL, NULL, .constantValue.asInt = ACConversationHistoryActor_LIMIT },
    { "KEY_LOADED_DATE_", NULL, 0x12, "Ljava.lang.String;", NULL, NULL, .constantValue.asLong = 0 },
    { "KEY_LOADED_", NULL, 0x12, "Ljava.lang.String;", NULL, NULL, .constantValue.asLong = 0 },
    { "KEY_LOADED_INIT_", NULL, 0x12, "Ljava.lang.String;", NULL, NULL, .constantValue.asLong = 0 },
    { "peer_", NULL, 0x12, "Lim.actor.core.entity.Peer;", NULL, NULL, .constantValue.asLong = 0 },
    { "historyMaxDate_", NULL, 0x2, "J", NULL, NULL, .constantValue.asLong = 0 },
    { "historyLoaded_", NULL, 0x2, "Z", NULL, NULL, .constantValue.asLong = 0 },
    { "isLoading_", NULL, 0x2, "Z", NULL, NULL, .constantValue.asLong = 0 },
  };
  static const char *inner_classes[] = {"Lim.actor.core.modules.internal.messages.ConversationHistoryActor$LoadMore;", "Lim.actor.core.modules.internal.messages.ConversationHistoryActor$LoadedMore;"};
  static const J2ObjcClassInfo _ACConversationHistoryActor = { 2, "ConversationHistoryActor", "im.actor.core.modules.internal.messages", NULL, 0x1, 5, methods, 8, fields, 0, NULL, 2, inner_classes, NULL, NULL };
  return &_ACConversationHistoryActor;
}

@end


#line 30
void ACConversationHistoryActor_initWithACPeer_withACModuleContext_(ACConversationHistoryActor *self, ACPeer *peer, id<ACModuleContext> context) {
  (void) ACModuleActor_initWithACModuleContext_(self, context);
  self->isLoading_ =
#line 28
  false;
  
#line 32
  self->peer_ = peer;
  self->KEY_LOADED_DATE_ = JreStrcat("$@$", @"conv_", peer, @"_history_date");
  self->KEY_LOADED_ = JreStrcat("$@$", @"conv_", peer, @"_history_loaded");
  self->KEY_LOADED_INIT_ = JreStrcat("$@$", @"conv_", peer, @"_history_inited");
}


#line 30
ACConversationHistoryActor *new_ACConversationHistoryActor_initWithACPeer_withACModuleContext_(ACPeer *peer, id<ACModuleContext> context) {
  ACConversationHistoryActor *self = [ACConversationHistoryActor alloc];
  ACConversationHistoryActor_initWithACPeer_withACModuleContext_(self, peer, context);
  return self;
}


#line 48
void ACConversationHistoryActor_onLoadMore(ACConversationHistoryActor *self) {
  if (self->historyLoaded_) {
    return;
  }
  if (self->isLoading_) {
    return;
  }
  self->isLoading_ = true;
  
#line 57
  [self requestWithACRequest:new_ARRequestLoadHistory_initWithARApiOutPeer_withLong_withInt_([self buidOutPeerWithACPeer:self->peer_], self->historyMaxDate_, ACConversationHistoryActor_LIMIT) withACRpcCallback:new_ACConversationHistoryActor_$1_initWithACConversationHistoryActor_(self)];
}


#line 73
void ACConversationHistoryActor_onLoadedMoreWithInt_withLong_(ACConversationHistoryActor *self, jint loaded, jlong maxLoadedDate) {
  self->isLoading_ = false;
  
#line 76
  if (loaded < ACConversationHistoryActor_LIMIT) {
    self->historyLoaded_ = true;
  }
  else {
    
#line 79
    self->historyLoaded_ = false;
    self->historyMaxDate_ = maxLoadedDate;
  }
  
#line 83
  [((id<ARPreferencesStorage>) nil_chk([self preferences])) putLongWithKey:self->KEY_LOADED_DATE_ withValue:maxLoadedDate];
  [((id<ARPreferencesStorage>) nil_chk([self preferences])) putBoolWithKey:self->KEY_LOADED_ withValue:self->historyLoaded_];
  [((id<ARPreferencesStorage>) nil_chk([self preferences])) putBoolWithKey:self->KEY_LOADED_INIT_ withValue:true];
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ACConversationHistoryActor)

#line 0 "/Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/ConversationHistoryActor.java"


#line 100
@implementation ACConversationHistoryActor_LoadMore

J2OBJC_IGNORE_DESIGNATED_BEGIN
- (instancetype)init {
  ACConversationHistoryActor_LoadMore_init(self);
  return self;
}
J2OBJC_IGNORE_DESIGNATED_END

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "init", NULL, NULL, 0x1, NULL, NULL },
  };
  static const J2ObjcClassInfo _ACConversationHistoryActor_LoadMore = { 2, "LoadMore", "im.actor.core.modules.internal.messages", "ConversationHistoryActor", 0x9, 1, methods, 0, NULL, 0, NULL, 0, NULL, NULL, NULL };
  return &_ACConversationHistoryActor_LoadMore;
}

@end

void ACConversationHistoryActor_LoadMore_init(ACConversationHistoryActor_LoadMore *self) {
  (void) NSObject_init(self);
}

ACConversationHistoryActor_LoadMore *new_ACConversationHistoryActor_LoadMore_init() {
  ACConversationHistoryActor_LoadMore *self = [ACConversationHistoryActor_LoadMore alloc];
  ACConversationHistoryActor_LoadMore_init(self);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ACConversationHistoryActor_LoadMore)

#line 0 "/Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/ConversationHistoryActor.java"


#line 104
@implementation ACConversationHistoryActor_LoadedMore


#line 108
- (instancetype)initWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate {
  ACConversationHistoryActor_LoadedMore_initWithInt_withLong_(self, loaded, maxLoadedDate);
  return self;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithInt:withLong:", "LoadedMore", NULL, 0x1, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "loaded_", NULL, 0x2, "I", NULL, NULL, .constantValue.asLong = 0 },
    { "maxLoadedDate_", NULL, 0x2, "J", NULL, NULL, .constantValue.asLong = 0 },
  };
  static const J2ObjcClassInfo _ACConversationHistoryActor_LoadedMore = { 2, "LoadedMore", "im.actor.core.modules.internal.messages", "ConversationHistoryActor", 0x9, 1, methods, 2, fields, 0, NULL, 0, NULL, NULL, NULL };
  return &_ACConversationHistoryActor_LoadedMore;
}

@end


#line 108
void ACConversationHistoryActor_LoadedMore_initWithInt_withLong_(ACConversationHistoryActor_LoadedMore *self, jint loaded, jlong maxLoadedDate) {
  (void) NSObject_init(self);
  
#line 109
  self->loaded_ = loaded;
  self->maxLoadedDate_ = maxLoadedDate;
}


#line 108
ACConversationHistoryActor_LoadedMore *new_ACConversationHistoryActor_LoadedMore_initWithInt_withLong_(jint loaded, jlong maxLoadedDate) {
  ACConversationHistoryActor_LoadedMore *self = [ACConversationHistoryActor_LoadedMore alloc];
  ACConversationHistoryActor_LoadedMore_initWithInt_withLong_(self, loaded, maxLoadedDate);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ACConversationHistoryActor_LoadedMore)

#line 0 "/Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/ConversationHistoryActor.java"

@implementation ACConversationHistoryActor_$1


#line 60
- (void)onResult:(ARResponseLoadHistory *)response {
  
#line 62
  [((ACUpdates *) nil_chk([this$0_ updates])) onUpdateReceivedWithId:new_ACMessagesHistoryLoaded_initWithACPeer_withARResponseLoadHistory_(this$0_->peer_, response)];
}

- (void)onError:(ACRpcException *)e {
  [((ACRpcException *) nil_chk(e)) printStackTrace];
}

- (instancetype)initWithACConversationHistoryActor:(ACConversationHistoryActor *)outer$ {
  ACConversationHistoryActor_$1_initWithACConversationHistoryActor_(self, outer$);
  return self;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "onResult:", "onResult", "V", 0x1, NULL, NULL },
    { "onError:", "onError", "V", 0x1, NULL, NULL },
    { "initWithACConversationHistoryActor:", "", NULL, 0x0, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lim.actor.core.modules.internal.messages.ConversationHistoryActor;", NULL, NULL, .constantValue.asLong = 0 },
  };
  static const J2ObjCEnclosingMethodInfo enclosing_method = { "ACConversationHistoryActor", "onLoadMore" };
  static const J2ObjcClassInfo _ACConversationHistoryActor_$1 = { 2, "", "im.actor.core.modules.internal.messages", "ConversationHistoryActor", 0x8008, 3, methods, 1, fields, 0, NULL, 0, NULL, &enclosing_method, "Ljava/lang/Object;Lim/actor/core/network/RpcCallback<Lim/actor/core/api/rpc/ResponseLoadHistory;>;" };
  return &_ACConversationHistoryActor_$1;
}

@end

void ACConversationHistoryActor_$1_initWithACConversationHistoryActor_(ACConversationHistoryActor_$1 *self, ACConversationHistoryActor *outer$) {
  self->this$0_ = outer$;
  (void) NSObject_init(self);
}

ACConversationHistoryActor_$1 *new_ACConversationHistoryActor_$1_initWithACConversationHistoryActor_(ACConversationHistoryActor *outer$) {
  ACConversationHistoryActor_$1 *self = [ACConversationHistoryActor_$1 alloc];
  ACConversationHistoryActor_$1_initWithACConversationHistoryActor_(self, outer$);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ACConversationHistoryActor_$1)

#pragma clang diagnostic pop
