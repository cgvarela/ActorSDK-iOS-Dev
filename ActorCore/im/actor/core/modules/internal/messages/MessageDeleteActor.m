//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/MessageDeleteActor.java
//

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "im/actor/core/api/ApiOutPeer.h"
#include "im/actor/core/api/ApiPeer.h"
#include "im/actor/core/api/base/SeqUpdate.h"
#include "im/actor/core/api/rpc/RequestDeleteMessage.h"
#include "im/actor/core/api/rpc/ResponseSeq.h"
#include "im/actor/core/api/updates/UpdateMessageDelete.h"
#include "im/actor/core/entity/Peer.h"
#include "im/actor/core/modules/ModuleContext.h"
#include "im/actor/core/modules/Updates.h"
#include "im/actor/core/modules/internal/MessagesModule.h"
#include "im/actor/core/modules/internal/messages/MessageDeleteActor.h"
#include "im/actor/core/modules/internal/messages/entity/Delete.h"
#include "im/actor/core/modules/internal/messages/entity/DeleteStorage.h"
#include "im/actor/core/modules/utils/ModuleActor.h"
#include "im/actor/core/network/RpcCallback.h"
#include "im/actor/core/network/RpcException.h"
#include "im/actor/runtime/actors/Actor.h"
#include "im/actor/runtime/storage/SyncKeyValue.h"
#include "java/io/IOException.h"
#include "java/lang/Long.h"
#include "java/util/ArrayList.h"
#include "java/util/HashMap.h"
#include "java/util/List.h"
#include "java/util/Set.h"

#pragma clang diagnostic push
#pragma GCC diagnostic ignored "-Wdeprecated-declarations"

@interface ACMessageDeleteActor () {
 @public
  ARSyncKeyValue *syncKeyValue_;
  ACDeleteStorage *deleteStorage_;
}

@end

J2OBJC_FIELD_SETTER(ACMessageDeleteActor, syncKeyValue_, ARSyncKeyValue *)
J2OBJC_FIELD_SETTER(ACMessageDeleteActor, deleteStorage_, ACDeleteStorage *)

@interface ACMessageDeleteActor_DeleteMessage () {
 @public
  ACPeer *peer_;
  IOSLongArray *rids_;
}

@end

J2OBJC_FIELD_SETTER(ACMessageDeleteActor_DeleteMessage, peer_, ACPeer *)
J2OBJC_FIELD_SETTER(ACMessageDeleteActor_DeleteMessage, rids_, IOSLongArray *)

@interface ACMessageDeleteActor_$1 : NSObject < ACRpcCallback > {
 @public
  ACMessageDeleteActor *this$0_;
  ACPeer *val$peer_;
  id<JavaUtilList> val$rids_;
  ARApiPeer *val$apiPeer_;
}

- (void)onResult:(ARResponseSeq *)response;

- (void)onError:(ACRpcException *)e;

- (instancetype)initWithACMessageDeleteActor:(ACMessageDeleteActor *)outer$
                                  withACPeer:(ACPeer *)capture$0
                            withJavaUtilList:(id<JavaUtilList>)capture$1
                               withARApiPeer:(ARApiPeer *)capture$2;

@end

J2OBJC_EMPTY_STATIC_INIT(ACMessageDeleteActor_$1)

J2OBJC_FIELD_SETTER(ACMessageDeleteActor_$1, this$0_, ACMessageDeleteActor *)
J2OBJC_FIELD_SETTER(ACMessageDeleteActor_$1, val$peer_, ACPeer *)
J2OBJC_FIELD_SETTER(ACMessageDeleteActor_$1, val$rids_, id<JavaUtilList>)
J2OBJC_FIELD_SETTER(ACMessageDeleteActor_$1, val$apiPeer_, ARApiPeer *)

__attribute__((unused)) static void ACMessageDeleteActor_$1_initWithACMessageDeleteActor_withACPeer_withJavaUtilList_withARApiPeer_(ACMessageDeleteActor_$1 *self, ACMessageDeleteActor *outer$, ACPeer *capture$0, id<JavaUtilList> capture$1, ARApiPeer *capture$2);

__attribute__((unused)) static ACMessageDeleteActor_$1 *new_ACMessageDeleteActor_$1_initWithACMessageDeleteActor_withACPeer_withJavaUtilList_withARApiPeer_(ACMessageDeleteActor *outer$, ACPeer *capture$0, id<JavaUtilList> capture$1, ARApiPeer *capture$2) NS_RETURNS_RETAINED;

J2OBJC_TYPE_LITERAL_HEADER(ACMessageDeleteActor_$1)

#line 0 "/Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/MessageDeleteActor.java"


#line 26
@implementation ACMessageDeleteActor


#line 31
- (instancetype)initWithACModuleContext:(id<ACModuleContext>)context {
  ACMessageDeleteActor_initWithACModuleContext_(self, context);
  return self;
}


#line 37
- (void)preStart {
  [super preStart];
  IOSByteArray *data = [((ARSyncKeyValue *) nil_chk(syncKeyValue_)) getWithLong:ACModuleActor_CURSOR_DELETE];
  if (data != nil) {
    @try {
      deleteStorage_ = ACDeleteStorage_fromBytesWithByteArray_(data);
    }
    @catch (
#line 43
    JavaIoIOException *e) {
      [((JavaIoIOException *) nil_chk(e)) printStackTrace];
      deleteStorage_ = new_ACDeleteStorage_init();
    }
  }
  else {
    
#line 48
    deleteStorage_ = new_ACDeleteStorage_init();
  }
  
#line 51
  for (ACPeer * __strong peer in nil_chk([((JavaUtilHashMap *) nil_chk([((ACDeleteStorage *) nil_chk(deleteStorage_)) getPendingDeletions])) keySet])) {
    ACDelete *delete_ = [((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) getWithId:peer];
    if ([((id<JavaUtilList>) nil_chk([((ACDelete *) nil_chk(delete_)) getRids])) size] > 0) {
      [self performDeleteWithACPeer:peer withJavaUtilList:[delete_ getRids]];
    }
  }
}


#line 59
- (void)saveStorage {
  [((ARSyncKeyValue *) nil_chk(syncKeyValue_)) putWithLong:ACModuleActor_CURSOR_DELETE withByteArray:[((ACDeleteStorage *) nil_chk(deleteStorage_)) toByteArray]];
}

- (void)performDeleteWithACPeer:(ACPeer *)peer
               withJavaUtilList:(id<JavaUtilList>)rids {
  ARApiOutPeer *outPeer = [self buidOutPeerWithACPeer:peer];
  ARApiPeer *apiPeer = [self buildApiPeerWithACPeer:peer];
  [self requestWithACRequest:new_ARRequestDeleteMessage_initWithARApiOutPeer_withJavaUtilList_(outPeer, rids) withACRpcCallback:new_ACMessageDeleteActor_$1_initWithACMessageDeleteActor_withACPeer_withJavaUtilList_withARApiPeer_(self, peer, rids, apiPeer)];
}


#line 86
- (void)onDeleteMessageWithACPeer:(ACPeer *)peer
                 withJavaUtilList:(id<JavaUtilList>)rids {
  
#line 88
  if (![((JavaUtilHashMap *) nil_chk([((ACDeleteStorage *) nil_chk(deleteStorage_)) getPendingDeletions])) containsKeyWithId:peer]) {
    (void) [((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) putWithId:peer withId:new_ACDelete_initWithACPeer_withJavaUtilList_(peer, new_JavaUtilArrayList_init())];
  }
  [((id<JavaUtilList>) nil_chk([((ACDelete *) nil_chk([((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) getWithId:peer])) getRids])) addAllWithJavaUtilCollection:rids];
  [self saveStorage];
  
#line 95
  [self performDeleteWithACPeer:peer withJavaUtilList:rids];
}


#line 99
- (void)onReceiveWithId:(id)message {
  if ([message isKindOfClass:[ACMessageDeleteActor_DeleteMessage class]]) {
    ACMessageDeleteActor_DeleteMessage *deleteMessage = (ACMessageDeleteActor_DeleteMessage *) check_class_cast(message, [ACMessageDeleteActor_DeleteMessage class]);
    JavaUtilArrayList *rids = new_JavaUtilArrayList_init();
    {
      IOSLongArray *a__ =
#line 103
      [((ACMessageDeleteActor_DeleteMessage *) nil_chk(deleteMessage)) getRids];
      jlong const *b__ = ((IOSLongArray *) nil_chk(a__))->buffer_;
      jlong const *e__ = b__ + a__->size_;
      while (b__ < e__) {
        jlong l = *b__++;
        
#line 104
        [rids addWithId:JavaLangLong_valueOfWithLong_(l)];
      }
    }
    
#line 106
    [self onDeleteMessageWithACPeer:[deleteMessage getPeer] withJavaUtilList:rids];
  }
  else {
    
#line 108
    [self dropWithId:message];
  }
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithACModuleContext:", "MessageDeleteActor", NULL, 0x1, NULL, NULL },
    { "preStart", NULL, "V", 0x1, NULL, NULL },
    { "saveStorage", NULL, "V", 0x0, NULL, NULL },
    { "performDeleteWithACPeer:withJavaUtilList:", "performDelete", "V", 0x1, NULL, NULL },
    { "onDeleteMessageWithACPeer:withJavaUtilList:", "onDeleteMessage", "V", 0x1, NULL, NULL },
    { "onReceiveWithId:", "onReceive", "V", 0x1, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "syncKeyValue_", NULL, 0x2, "Lim.actor.runtime.storage.SyncKeyValue;", NULL, NULL, .constantValue.asLong = 0 },
    { "deleteStorage_", NULL, 0x2, "Lim.actor.core.modules.internal.messages.entity.DeleteStorage;", NULL, NULL, .constantValue.asLong = 0 },
  };
  static const char *inner_classes[] = {"Lim.actor.core.modules.internal.messages.MessageDeleteActor$DeleteMessage;"};
  static const J2ObjcClassInfo _ACMessageDeleteActor = { 2, "MessageDeleteActor", "im.actor.core.modules.internal.messages", NULL, 0x1, 6, methods, 2, fields, 0, NULL, 1, inner_classes, NULL, NULL };
  return &_ACMessageDeleteActor;
}

@end


#line 31
void ACMessageDeleteActor_initWithACModuleContext_(ACMessageDeleteActor *self, id<ACModuleContext> context) {
  (void) ACModuleActor_initWithACModuleContext_(self, context);
  self->syncKeyValue_ = [((ACMessagesModule *) nil_chk([((id<ACModuleContext>) nil_chk(context)) getMessagesModule])) getCursorStorage];
}


#line 31
ACMessageDeleteActor *new_ACMessageDeleteActor_initWithACModuleContext_(id<ACModuleContext> context) {
  ACMessageDeleteActor *self = [ACMessageDeleteActor alloc];
  ACMessageDeleteActor_initWithACModuleContext_(self, context);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ACMessageDeleteActor)

#line 0 "/Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/MessageDeleteActor.java"


#line 112
@implementation ACMessageDeleteActor_DeleteMessage


#line 116
- (instancetype)initWithACPeer:(ACPeer *)peer
                 withLongArray:(IOSLongArray *)rids {
  ACMessageDeleteActor_DeleteMessage_initWithACPeer_withLongArray_(self, peer, rids);
  return self;
}


#line 121
- (ACPeer *)getPeer {
  return peer_;
}

- (IOSLongArray *)getRids {
  return rids_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithACPeer:withLongArray:", "DeleteMessage", NULL, 0x1, NULL, NULL },
    { "getPeer", NULL, "Lim.actor.core.entity.Peer;", 0x1, NULL, NULL },
    { "getRids", NULL, "[J", 0x1, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "peer_", NULL, 0x2, "Lim.actor.core.entity.Peer;", NULL, NULL, .constantValue.asLong = 0 },
    { "rids_", NULL, 0x2, "[J", NULL, NULL, .constantValue.asLong = 0 },
  };
  static const J2ObjcClassInfo _ACMessageDeleteActor_DeleteMessage = { 2, "DeleteMessage", "im.actor.core.modules.internal.messages", "MessageDeleteActor", 0x9, 3, methods, 2, fields, 0, NULL, 0, NULL, NULL, NULL };
  return &_ACMessageDeleteActor_DeleteMessage;
}

@end


#line 116
void ACMessageDeleteActor_DeleteMessage_initWithACPeer_withLongArray_(ACMessageDeleteActor_DeleteMessage *self, ACPeer *peer, IOSLongArray *rids) {
  (void) NSObject_init(self);
  
#line 117
  self->peer_ = peer;
  self->rids_ = rids;
}


#line 116
ACMessageDeleteActor_DeleteMessage *new_ACMessageDeleteActor_DeleteMessage_initWithACPeer_withLongArray_(ACPeer *peer, IOSLongArray *rids) {
  ACMessageDeleteActor_DeleteMessage *self = [ACMessageDeleteActor_DeleteMessage alloc];
  ACMessageDeleteActor_DeleteMessage_initWithACPeer_withLongArray_(self, peer, rids);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ACMessageDeleteActor_DeleteMessage)

#line 0 "/Users/ex3ndr/Develop/actor-proprietary/actor-sdk/sdk-core/core/core-shared/src/main/java//im/actor/core/modules/internal/messages/MessageDeleteActor.java"

@implementation ACMessageDeleteActor_$1


#line 69
- (void)onResult:(ARResponseSeq *)response {
  if ([((JavaUtilHashMap *) nil_chk([((ACDeleteStorage *) nil_chk(this$0_->deleteStorage_)) getPendingDeletions])) containsKeyWithId:val$peer_]) {
    [((id<JavaUtilList>) nil_chk([((ACDelete *) nil_chk([((JavaUtilHashMap *) nil_chk([this$0_->deleteStorage_ getPendingDeletions])) getWithId:val$peer_])) getRids])) removeAllWithJavaUtilCollection:val$rids_];
    [this$0_ saveStorage];
  }
  
#line 75
  [((ACUpdates *) nil_chk([this$0_ updates])) onUpdateReceivedWithId:new_ARSeqUpdate_initWithInt_withByteArray_withInt_withByteArray_([((ARResponseSeq *) nil_chk(response)) getSeq], [response getState],
#line 76
  ARUpdateMessageDelete_HEADER, [new_ARUpdateMessageDelete_initWithARApiPeer_withJavaUtilList_(val$apiPeer_, val$rids_) toByteArray])];
}


#line 80
- (void)onError:(ACRpcException *)e {
}

- (instancetype)initWithACMessageDeleteActor:(ACMessageDeleteActor *)outer$
                                  withACPeer:(ACPeer *)capture$0
                            withJavaUtilList:(id<JavaUtilList>)capture$1
                               withARApiPeer:(ARApiPeer *)capture$2 {
  ACMessageDeleteActor_$1_initWithACMessageDeleteActor_withACPeer_withJavaUtilList_withARApiPeer_(self, outer$, capture$0, capture$1, capture$2);
  return self;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "onResult:", "onResult", "V", 0x1, NULL, NULL },
    { "onError:", "onError", "V", 0x1, NULL, NULL },
    { "initWithACMessageDeleteActor:withACPeer:withJavaUtilList:withARApiPeer:", "", NULL, 0x0, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lim.actor.core.modules.internal.messages.MessageDeleteActor;", NULL, NULL, .constantValue.asLong = 0 },
    { "val$peer_", NULL, 0x1012, "Lim.actor.core.entity.Peer;", NULL, NULL, .constantValue.asLong = 0 },
    { "val$rids_", NULL, 0x1012, "Ljava.util.List;", NULL, "Ljava/util/List<Ljava/lang/Long;>;", .constantValue.asLong = 0 },
    { "val$apiPeer_", NULL, 0x1012, "Lim.actor.core.api.ApiPeer;", NULL, NULL, .constantValue.asLong = 0 },
  };
  static const J2ObjCEnclosingMethodInfo enclosing_method = { "ACMessageDeleteActor", "performDeleteWithACPeer:withJavaUtilList:" };
  static const J2ObjcClassInfo _ACMessageDeleteActor_$1 = { 2, "", "im.actor.core.modules.internal.messages", "MessageDeleteActor", 0x8008, 3, methods, 4, fields, 0, NULL, 0, NULL, &enclosing_method, "Ljava/lang/Object;Lim/actor/core/network/RpcCallback<Lim/actor/core/api/rpc/ResponseSeq;>;" };
  return &_ACMessageDeleteActor_$1;
}

@end

void ACMessageDeleteActor_$1_initWithACMessageDeleteActor_withACPeer_withJavaUtilList_withARApiPeer_(ACMessageDeleteActor_$1 *self, ACMessageDeleteActor *outer$, ACPeer *capture$0, id<JavaUtilList> capture$1, ARApiPeer *capture$2) {
  self->this$0_ = outer$;
  self->val$peer_ = capture$0;
  self->val$rids_ = capture$1;
  self->val$apiPeer_ = capture$2;
  (void) NSObject_init(self);
}

ACMessageDeleteActor_$1 *new_ACMessageDeleteActor_$1_initWithACMessageDeleteActor_withACPeer_withJavaUtilList_withARApiPeer_(ACMessageDeleteActor *outer$, ACPeer *capture$0, id<JavaUtilList> capture$1, ARApiPeer *capture$2) {
  ACMessageDeleteActor_$1 *self = [ACMessageDeleteActor_$1 alloc];
  ACMessageDeleteActor_$1_initWithACMessageDeleteActor_withACPeer_withJavaUtilList_withARApiPeer_(self, outer$, capture$0, capture$1, capture$2);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ACMessageDeleteActor_$1)

#pragma clang diagnostic pop
